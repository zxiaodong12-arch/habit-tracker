# 修复数据库连接超时问题

## 错误信息

```
SQLSTATE[HY000] [2002] Connection timed out
```

## 问题原因

数据库连接超时，可能的原因：
1. 数据库服务未启动
2. 数据库配置错误（IP、端口、用户名、密码）
3. 防火墙阻止连接
4. 数据库服务器不可达

## 诊断步骤

### 1. 检查数据库服务是否运行

```bash
# 检查 MySQL/MariaDB 服务状态
sudo systemctl status mysql    # Ubuntu
# 或
sudo systemctl status mariadb  # CentOS/OpenCloudOS

# 如果未运行，启动服务
sudo systemctl start mysql
sudo systemctl enable mysql    # 设置开机自启
```

### 2. 检查数据库配置

查看 `.env` 文件（在 `api` 目录下）：

```bash
cd /var/www/habit-tracker/api
cat .env
```

**正确的配置应该是：**

```ini
[DATABASE]
TYPE = mysql
HOSTNAME = 127.0.0.1    # 如果数据库在同一台服务器，使用 127.0.0.1
# 或
HOSTNAME = localhost    # 也可以使用 localhost
DATABASE = habit_tracker
USERNAME = root         # 或你创建的用户名
PASSWORD = 你的密码
HOSTPORT = 3306
CHARSET = utf8mb4
```

**注意：**
- 如果数据库在**同一台服务器**，使用 `127.0.0.1` 或 `localhost`
- 如果数据库在**其他服务器**，使用数据库服务器的 IP

### 3. 测试数据库连接

```bash
# 使用命令行测试连接
mysql -h 127.0.0.1 -u root -p habit_tracker

# 或使用配置的 IP
mysql -h 1.15.12.78 -u root -p habit_tracker
```

如果连接失败，说明：
- 数据库服务未启动
- 用户名/密码错误
- 数据库不存在

### 4. 检查防火墙

```bash
# CentOS/OpenCloudOS
sudo firewall-cmd --list-all

# 如果 MySQL 端口被阻止，添加规则
sudo firewall-cmd --permanent --add-service=mysql
sudo firewall-cmd --reload

# Ubuntu
sudo ufw status
sudo ufw allow 3306/tcp
```

### 5. 检查数据库是否存在

```bash
mysql -u root -p
```

```sql
-- 查看所有数据库
SHOW DATABASES;

-- 如果 habit_tracker 不存在，创建它
CREATE DATABASE habit_tracker DEFAULT CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;

-- 退出
EXIT;
```

## 解决方案

### 方案一：修复数据库配置（如果数据库在同一台服务器）

1. **编辑 `.env` 文件**

```bash
cd /var/www/habit-tracker/api
vi .env
```

2. **修改配置**

```ini
[DATABASE]
TYPE = mysql
HOSTNAME = 127.0.0.1    # 改为 127.0.0.1（本地）
DATABASE = habit_tracker
USERNAME = root
PASSWORD = 你的数据库密码
HOSTPORT = 3306
CHARSET = utf8mb4
```

3. **保存并重启服务**

```bash
# 重启 PHP-FPM
sudo systemctl restart php-fpm

# 重启 Nginx
sudo systemctl restart nginx
```

### 方案二：如果数据库在其他服务器

1. **确保数据库服务器允许远程连接**

```sql
-- 在数据库服务器上执行
GRANT ALL PRIVILEGES ON habit_tracker.* TO 'root'@'1.15.12.78' IDENTIFIED BY '密码';
FLUSH PRIVILEGES;
```

2. **检查数据库服务器防火墙**

确保数据库服务器的 3306 端口开放。

3. **修改 `.env` 配置**

```ini
[DATABASE]
HOSTNAME = 数据库服务器IP    # 改为数据库服务器的 IP
```

### 方案三：创建数据库和用户（如果数据库不存在）

```bash
# 登录 MySQL
mysql -u root -p
```

```sql
-- 创建数据库
CREATE DATABASE habit_tracker DEFAULT CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;

-- 创建用户（可选，建议使用独立用户）
CREATE USER 'habit_user'@'localhost' IDENTIFIED BY '你的密码';
GRANT ALL PRIVILEGES ON habit_tracker.* TO 'habit_user'@'localhost';
FLUSH PRIVILEGES;

-- 退出
EXIT;
```

然后导入数据库结构：

```bash
cd /var/www/habit-tracker
mysql -u root -p habit_tracker < database.sql
```

## 快速修复步骤

### 1. 检查数据库服务

```bash
sudo systemctl status mysql
# 如果未运行
sudo systemctl start mysql
```

### 2. 检查配置

```bash
cd /var/www/habit-tracker/api
cat .env | grep -A 10 DATABASE
```

### 3. 测试连接

```bash
mysql -h 127.0.0.1 -u root -p habit_tracker
```

### 4. 修复配置

如果配置错误，编辑 `.env` 文件：

```bash
vi /var/www/habit-tracker/api/.env
```

确保：
- `HOSTNAME = 127.0.0.1`（如果数据库在同一台服务器）
- `DATABASE = habit_tracker`
- `USERNAME` 和 `PASSWORD` 正确

### 5. 重启服务

```bash
sudo systemctl restart php-fpm
sudo systemctl restart nginx
```

## 验证

修复后，再次测试登录：

```bash
curl -X POST 'http://1.15.12.78/api/auth/login' \
-H 'Content-Type: application/json' \
-d '{"username":"legolas","password":"021271"}'
```

应该返回成功响应，而不是连接超时错误。

## 常见问题

### Q: 数据库在同一台服务器，应该用什么 IP？

**A:** 使用 `127.0.0.1` 或 `localhost`

### Q: 如何查看数据库是否运行？

**A:** 
```bash
sudo systemctl status mysql
```

### Q: 如何查看数据库配置？

**A:**
```bash
cat /var/www/habit-tracker/api/.env
```

### Q: 如何测试数据库连接？

**A:**
```bash
mysql -h 127.0.0.1 -u root -p habit_tracker
```

## 总结

**问题：** 数据库连接超时

**最可能的原因：**
1. 数据库服务未启动
2. 配置中的 IP 错误（应该用 127.0.0.1 而不是服务器公网 IP）
3. 数据库不存在

**解决步骤：**
1. 检查数据库服务状态
2. 检查并修复 `.env` 配置
3. 测试数据库连接
4. 重启 PHP-FPM 和 Nginx
